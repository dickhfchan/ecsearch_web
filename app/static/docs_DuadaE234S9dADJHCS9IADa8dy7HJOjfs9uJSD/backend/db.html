<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Database &amp; Elasticsearch | Rolltrek</title>
    <meta name="description" content="Docs of Rolltrek.">
    
    
    <link rel="preload" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/css/0.styles.9e867fc4.css" as="style"><link rel="preload" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/app.88c0bc44.js" as="script"><link rel="preload" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/4.5c003080.js" as="script"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/10.eefc37ab.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/11.842f08a3.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/12.f5b65626.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/13.4e395adc.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/14.7edf6ab8.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/2.5cae0519.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/3.5face3d2.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/5.eab7c3ed.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/6.96936887.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/7.df5e88dc.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/8.5ff3b723.js"><link rel="prefetch" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/9.a1b743c3.js">
    <link rel="stylesheet" href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/css/0.styles.9e867fc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/" class="home-link router-link-active"><!----> <span class="site-name">Rolltrek</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/todo.html" class="nav-link">Github</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/todo.html" class="nav-link">Github</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>Backend</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/dependencies-notes.html" class="sidebar-link">Dependencies Notes</a></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/how-to-run.html" class="sidebar-link">How to Run</a></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/structure.html" class="sidebar-link">Structure</a></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html" class="active sidebar-link">Database &amp; Elasticsearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#commands" class="sidebar-link">Commands</a></li><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#add-update-delete" class="sidebar-link">Add, Update, Delete</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#add" class="sidebar-link">Add</a></li><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#update" class="sidebar-link">Update</a></li><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#delete" class="sidebar-link">Delete</a></li></ul></li><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#read" class="sidebar-link">Read</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#read-by-cassandra-python-driver" class="sidebar-link">Read by Cassandra python driver</a></li><li class="sidebar-sub-header"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/db.html#read-by-elasticsearch" class="sidebar-link">Read by Elasticsearch</a></li></ul></li></ul></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/utils.html" class="sidebar-link">Utils</a></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/form-validation.html" class="sidebar-link">Form Validation</a></li><li><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/schedule-task.html" class="sidebar-link">Schedule Task</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Frontend</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="database-elasticsearch"><a href="#database-elasticsearch" aria-hidden="true" class="header-anchor">#</a> Database &amp; Elasticsearch</h1> <p>The project uses Elassandra(Elasticsearch + Cassandra). Cassandra python driver to access database. Custom methods to search in database.</p> <ul><li><a href="https://www.elassandra.io/" target="_blank" rel="noopener noreferrer">Elassandra<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://cassandra.apache.org/" target="_blank" rel="noopener noreferrer">Cassandra<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.elastic.co/products/elasticsearch" target="_blank" rel="noopener noreferrer">Elasticsearch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.datastax.com/en/developer/python-driver/3.18/" target="_blank" rel="noopener noreferrer">Cassandra python driver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="commands"><a href="#commands" aria-hidden="true" class="header-anchor">#</a> Commands</h2> <p>/db.py provides commands to access database.</p> <div class="language-sh extra-class"><pre class="language-text"><code># delete keyspace and recreate by define in /models.
python db.py --recreate
# development mode. development config will be detected.
python db.py --recreate --dev
# delete elastic indexes and recreate by define in /app/elastic.py
python db.py --elastic
# seed database. check /app/seeds/
python db.py --seed
# do all together
python db.py --recreate --elastic --seed --dev
</code></pre></div><h2 id="add-update-delete"><a href="#add-update-delete" aria-hidden="true" class="header-anchor">#</a> Add, Update, Delete</h2> <p>Cassandra python driver has many methods to do these. But in /app/cassandra_cqlengine.py, part of the methods are overrided to work with hooks. So just use follow methods:</p> <h3 id="add"><a href="#add" aria-hidden="true" class="header-anchor">#</a> Add</h3> <div class="language-py extra-class"><pre class="language-py"><code>course <span class="token operator">=</span> Course<span class="token punctuation">.</span>create<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'pending'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'title'</span><span class="token punctuation">)</span>
<span class="token comment"># recommended</span>
course_data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'pending'</span><span class="token punctuation">,</span>
  <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
course <span class="token operator">=</span> Course<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token operator">**</span>course_data<span class="token punctuation">)</span>
</code></pre></div><h3 id="update"><a href="#update" aria-hidden="true" class="header-anchor">#</a> Update</h3> <p>Fetch item before update.</p> <div class="language-py extra-class"><pre class="language-py"><code>course <span class="token operator">=</span> Course<span class="token punctuation">.</span>objects<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
course<span class="token punctuation">.</span>update<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'pending'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'title'</span><span class="token punctuation">)</span>
<span class="token comment"># recommended</span>
course <span class="token operator">=</span> Course<span class="token punctuation">.</span>objects<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
course_data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'pending'</span><span class="token punctuation">,</span>
  <span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
course<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token operator">**</span>course_data<span class="token punctuation">)</span>
</code></pre></div><h3 id="delete"><a href="#delete" aria-hidden="true" class="header-anchor">#</a> Delete</h3> <p>Fetch item before update.</p> <div class="language-py extra-class"><pre class="language-py"><code>course <span class="token operator">=</span> Course<span class="token punctuation">.</span>objects<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
course<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="read"><a href="#read" aria-hidden="true" class="header-anchor">#</a> Read</h2> <p>Query Cassandra is difficult. So Elasticsearch is using to support query.</p> <h3 id="read-by-cassandra-python-driver"><a href="#read-by-cassandra-python-driver" aria-hidden="true" class="header-anchor">#</a> Read by Cassandra python driver</h3> <p>Python driver is still recommended to query when get by id.</p> <div class="language-py extra-class"><pre class="language-py"><code>course <span class="token operator">=</span> Course<span class="token punctuation">.</span>objects<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
course <span class="token operator">=</span> Course<span class="token punctuation">.</span>objects<span class="token punctuation">(</span>id__in<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'id1'</span><span class="token punctuation">,</span> <span class="token string">'id2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="read-by-elasticsearch"><a href="#read-by-elasticsearch" aria-hidden="true" class="header-anchor">#</a> Read by Elasticsearch</h3> <p>Elasticsearch is to do complex query. It exposes an api to do these works. Check its official docs to learn query api and format.
Its api is strong, but most functions of it we used are simple. So some methods are added to simplify the work at <code>app/plugins/cassandra_cqlengine_elastic.py</code>. The columns to query must be mappinged in <code>app/elastic.py</code>.</p> <h4 id="where"><a href="#where" aria-hidden="true" class="header-anchor">#</a> Where</h4> <div class="language-py extra-class"><pre class="language-py"><code>Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span>column<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span>column<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>column<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>column<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token comment"># when only 2 arguments, condition will be think as `=`</span>
Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span>column<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span>column<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>column<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
</code></pre></div><h5 id="conditions"><a href="#conditions" aria-hidden="true" class="header-anchor">#</a> Conditions</h5> <p>Supported now: &gt;, &lt;, =, &gt;=, &lt;=, in, between, &lt;between, between&gt;, &lt;between&gt;, common, exists, missing</p> <ul><li>between: &lt;= and &gt;=,</li> <li>&lt;between: &lt; and &gt;=,</li> <li>between&gt;: &lt;= and &gt;,</li> <li>&lt;between&gt;: &lt; and &gt;,</li> <li>common: <code>like</code>, full text search, the column elastic type must be text, such as course.title</li> <li>exists: not null</li> <li>missing: is null</li></ul> <h4 id="where2"><a href="#where2" aria-hidden="true" class="header-anchor">#</a> Where2</h4> <p>when use exists and missing, value is not required, use where2</p> <div class="language-py extra-class"><pre class="language-py"><code>Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>where2<span class="token punctuation">(</span>column<span class="token punctuation">,</span> <span class="token string">'exists'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="other-methods"><a href="#other-methods" aria-hidden="true" class="header-anchor">#</a> Other methods</h4> <ul><li>take(self, size, from_index=0)</li> <li>sort(self, name, order='desc')</li> <li>count()</li> <li>get()</li> <li>first()</li> <li>first_or_404()</li></ul> <div class="language-py extra-class"><pre class="language-py"><code>query <span class="token operator">=</span> Model<span class="token punctuation">.</span>elastic<span class="token punctuation">(</span>column<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>column<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>column<span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
rows <span class="token operator">=</span> query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># after get or first called, total hit data can be accessed by query.total</span>
total <span class="token operator">=</span> query<span class="token punctuation">.</span>total
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/structure.html" class="prev">
          Structure
        </a></span> <span class="next"><a href="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/backend/utils.html">
          Utils
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/app.88c0bc44.js" defer></script><script src="/static/docs_DuadaE234S9dADJHCS9IADa8dy7HJOjfs9uJSD/assets/js/4.5c003080.js" defer></script>
  </body>
</html>
